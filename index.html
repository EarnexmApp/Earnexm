<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EarnEXM Pro - Task System</title>
    <style>
        :root { --y: #ffcc00; --p: #ff00ff; --bg: #000b21; --b: #0088ff; }
        body { margin: 0; background: radial-gradient(circle at center, #001f5c 0%, #000b21 100%); color: white; font-family: 'Arial Black', sans-serif; height: 100vh; overflow: hidden; }
        
        .header { display: flex; justify-content: space-between; padding: 10px; align-items: center; background: rgba(0,0,0,0.8); border-bottom: 2px solid #111; }
        .stats-bar { background: #000; border: 1px solid #333; border-radius: 20px; padding: 6px 15px; display: flex; gap: 12px; font-size: 0.85rem; }

        .game-content { display: flex; flex-direction: column; align-items: center; padding-top: 15px; }
        .wheel-box { position: relative; width: 320px; height: 160px; overflow: hidden; border-bottom: 6px solid var(--y); }
        canvas { position: absolute; top: 0; left: 0; transition: transform 4s cubic-bezier(0.1, 0, 0, 1); }
        .pin { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--y); z-index: 10; }

        .ui-grid { position: absolute; width: 100%; top: 200px; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; }
        .btn-column { display: flex; flex-direction: column; gap: 18px; }
        .action-circle { width: 68px; height: 68px; background: var(--y); border-radius: 50%; border: 4px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 0 #000; }
        .action-circle span { font-size: 0.55rem; color: #000; font-weight: 900; text-align: center; }

        .main-btn { background: var(--y); padding: 15px 40px; border-radius: 50px; font-weight: 900; margin-top: 20px; border: none; border-bottom: 6px solid #b37a00; cursor: pointer; }
        .main-btn:disabled { background: #444; border-bottom-color: #222; color: #888; }

        /* Task Module */
        .task-box { background: #0a0a0a; border: 2px solid var(--b); border-radius: 20px; padding: 25px; width: 100%; text-align: center; }
        .timer-text { font-size: 2.5rem; color: var(--b); margin: 15px 0; text-shadow: 0 0 10px var(--b); }

        #toast { visibility: hidden; min-width: 250px; background-color: var(--y); color: #000; text-align: center; border-radius: 10px; padding: 16px; position: fixed; z-index: 2500; left: 50%; bottom: 50px; transform: translateX(-50%); font-weight: bold; border: 2px solid #000; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px; box-sizing: border-box; }
        .hidden { display: none !important; }
        .pro-input { width: 100%; padding: 14px; background: #000; border: 1px solid #333; color: white; border-radius: 12px; margin: 6px 0; }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 50px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 50px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div id="toast">Message</div>

    <div class="header">
        <button style="background:#111; color:white; padding:8px 15px; border-radius:10px;" onclick="window.close()">EXIT</button>
        <div class="stats-bar">
            <span>ü™ô <span id="e-val">0</span></span>
            <span style="color:red;">|</span>
            <span>üíµ <span id="u-val">0.0000</span></span>
        </div>
        <button style="background:#111; color:white; padding:8px 15px; border-radius:10px;" onclick="goHome()">BACK</button>
    </div>

    <div class="game-content">
        <div class="wheel-box">
            <div class="pin"></div>
            <canvas id="wheel" width="320" height="320"></canvas>
        </div>
        <button id="spin-btn" class="main-btn" onclick="handleSpin()">SPIN (10 EXM)</button>
        
        <button id="task-init-btn" class="main-btn" style="background:var(--b); border-bottom-color:#0055aa; margin-top:10px;" onclick="v('scr-tasks')">GIMME A TASK</button>

        <div class="ui-grid">
            <div class="btn-column">
                <div class="action-circle" onclick="v('scr-profile')">üë§<span>MY PROFILE</span></div>
                <div class="action-circle" onclick="v('scr-lucky')">üèÜ<span>LUCKY DRAW</span></div>
            </div>
            <div class="btn-column">
                <div class="action-circle" onclick="v('scr-withdraw')">üè¶<span>WITHDRAW</span></div>
                <div class="action-circle" onclick="v('scr-admin')">‚öôÔ∏è<span>ADMIN</span></div>
            </div>
        </div>
    </div>

    <div id="scr-tasks" class="overlay hidden">
        <div class="task-box" id="task-ui">
            <h2 id="task-title">EARN 10 EXM</h2>
            <p id="task-desc">Complete a quick visit to claim your reward.</p>
            <div id="task-timer" class="timer-text hidden">25</div>
            <button id="take-it-btn" class="main-btn" style="background:var(--b); width:100%;" onclick="startTask()">TAKE IT</button>
        </div>

        <div id="task-success" class="task-box hidden" style="border-color:lime;">
            <h2 style="color:lime;">CONGRATULATIONS!</h2>
            <p>Task completed successfully. Claim your 10 EXM now.</p>
            <button class="main-btn" style="background:lime; color:black; width:100%;" onclick="claimTask()">CLAIM 10 EXM</button>
        </div>

        <div id="task-fail" class="task-box hidden" style="border-color:red;">
            <h2 style="color:red;">TASK FAILED</h2>
            <p>You left too early! You earned 0 EXM. Try again.</p>
            <button class="main-btn" style="background:red; width:100%;" onclick="resetTask()">RETRY</button>
        </div>
        
        <p onclick="goHome()" id="task-close" style="margin-top:20px; cursor:pointer;">Close</p>
    </div>

    <div id="scr-profile" class="overlay hidden">
        <h2 style="color:var(--y)">MY PROFILE</h2>
        <div style="background:#0a0a0a; padding:20px; border-radius:15px; border:1px solid var(--y); width:100%;">
            <p>SECRET NAME: <span id="u-name" style="color:var(--y)"></span></p>
            <p>USER ID: <span id="u-id" style="color:var(--y)"></span></p>
            <button onclick="copyData()" style="width:100%; padding:10px; background:var(--y); border:none; font-weight:bold;">COPY INFO</button>
        </div>
        <button onclick="goHome()" style="margin-top:20px;">CLOSE</button>
    </div>

    <div id="scr-withdraw" class="overlay hidden">
        <h3>WITHDRAWAL</h3>
        <input type="text" id="w-wallet" class="pro-input" placeholder="USDT TRC20 Address">
        <input type="number" id="w-amount" class="pro-input" placeholder="Amount (EXM)">
        <input type="text" id="w-id-f" class="pro-input" placeholder="User ID">
        <input type="text" id="w-sn-f" class="pro-input" placeholder="Secret Name">
        <button style="background:var(--y); width:100%; padding:15px; border-radius:10px; font-weight:bold; color:black;" onclick="processMail('Withdrawal')">SEND REQUEST</button>
        <p onclick="goHome()">Back</p>
    </div>

    <div id="scr-admin" class="overlay hidden">
        <h2 style="color:var(--p)">ADMIN</h2>
        <input type="password" id="admin-key" class="pro-input" placeholder="Password">
        <button style="background:var(--p); width:100%; padding:10px; color:white;" onclick="adminAuth()">LOGIN</button>
        <div id="admin-tools" class="hidden" style="margin-top:20px; width:100%;">
            <input type="text" id="search-uid" class="pro-input" placeholder="Player ID">
            <input type="number" id="recycle-val" class="pro-input" placeholder="Amount ‚ôªÔ∏è">
            <button style="background:red; width:100%; padding:10px; color:white;" onclick="doRecycle()">RECYCLE</button>
        </div>
        <p onclick="goHome()">Close</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const config = { apiKey: "AIzaSyD3xCKkyQT-6FOURJBjBaTNKOFItL2M87Q", authDomain: "earnexmapp-8a0a2.firebaseapp.com", projectId: "earnexmapp-8a0a2", databaseURL: "https://earnexmapp-8a0a2-default-rtdb.firebaseio.com", appId: "1:325148626791:web:0448e65046bb38e365e9c2" };
        const app = initializeApp(config); const db = getDatabase(app);

        let finalId = localStorage.getItem('exm_final_id') || Math.floor(10000000 + Math.random() * 89999999).toString();
        let finalName = localStorage.getItem('exm_final_name') || Math.random().toString(36).substring(2, 12).toUpperCase();
        localStorage.setItem('exm_final_id', finalId); localStorage.setItem('exm_final_name', finalName);

        document.getElementById('u-id').innerText = finalId;
        document.getElementById('u-name').innerText = finalName;

        const userRef = ref(db, 'users/' + finalId);
        const randomLinks = ["https://otieu.com/4/10493012", "https://www.effectivegatecpm.com/njze4eg1xg?key=159eb9bfcd4ae292e143bc346e6aa518"];
        
        // Task Logic
        let timerVal = 25;
        let taskInterval;

        window.showToast = (msg) => {
            const t = document.getElementById("toast");
            t.innerText = msg; t.className = "show";
            setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
        };

        window.v = (id) => { document.querySelectorAll('.overlay').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); };
        window.goHome = () => { if(taskInterval) return; document.querySelectorAll('.overlay').forEach(s => s.classList.add('hidden')); };

        window.startTask = () => {
            const link = randomLinks[Math.floor(Math.random()*randomLinks.length)];
            window.open(link, "_blank");
            
            showToast("‚ö†Ô∏è Warning: Stay 25s or earn 0 EXM!");
            
            document.getElementById('take-it-btn').classList.add('hidden');
            document.getElementById('task-close').classList.add('hidden');
            document.getElementById('task-timer').classList.remove('hidden');
            
            timerVal = 25;
            document.getElementById('task-timer').innerText = timerVal;
            
            taskInterval = setInterval(() => {
                timerVal--;
                document.getElementById('task-timer').innerText = timerVal;
                if(timerVal <= 0) {
                    clearInterval(taskInterval);
                    taskInterval = null;
                    finishTask(true);
                }
            }, 1000);
        };

        function finishTask(success) {
            document.getElementById('task-ui').classList.add('hidden');
            if(success) {
                document.getElementById('task-success').classList.remove('hidden');
            } else {
                document.getElementById('task-fail').classList.remove('hidden');
            }
        }

        window.claimTask = async () => {
            const snap = await get(userRef);
            let cur = snap.val()?.exm || 500;
            update(userRef, {exm: cur + 10});
            showToast("üí∞ +10 EXM Claimed!");
            resetTask();
            goHome();
        };

        window.resetTask = () => {
            document.getElementById('task-ui').classList.remove('hidden');
            document.getElementById('task-success').classList.add('hidden');
            document.getElementById('task-fail').classList.add('hidden');
            document.getElementById('take-it-btn').classList.remove('hidden');
            document.getElementById('task-timer').classList.add('hidden');
            document.getElementById('task-close').classList.remove('hidden');
            timerVal = 25;
        };

        // Standard Functions
        window.handleSpin = async () => {
            const btn = document.getElementById('spin-btn');
            const snap = await get(userRef);
            let currentExm = snap.val()?.exm || 500;
            if(currentExm < 10) { showToast("Not enough EXM!"); return; }
            btn.disabled = true;
            update(userRef, {exm: currentExm - 10});
            document.getElementById('wheel').style.transform = `rotate(${5000 + Math.random()*5000}deg)`;
            setTimeout(() => {
                update(userRef, {exm: parseInt(document.getElementById('e-val').innerText) + 15});
                showToast("Success! +15 EXM");
                btn.disabled = false;
            }, 4000);
        };

        window.adminAuth = () => {
            if(document.getElementById('admin-key').value === "InisTa") {
                document.getElementById('admin-tools').classList.remove('hidden');
            } else { showToast("Wrong Password!"); }
        };

        window.doRecycle = async () => {
            const sid = document.getElementById('search-uid').value;
            const amt = parseInt(document.getElementById('recycle-val').value);
            const target = ref(db, 'users/' + sid);
            const snap = await get(target);
            if(snap.exists()) {
                update(target, {exm: (snap.val().exm || 0) - amt});
                showToast("‚ôªÔ∏è Recycled Successfully");
            } else { showToast("User Not Found!"); }
        };

        window.processMail = (t) => {
            const email = "earnexmads@gmail.com";
            let body = `Type: ${t}%0D%0AID: ${finalId}%0D%0AName: ${finalName}%0D%0AWallet: ${document.getElementById('w-wallet').value}%0D%0AAmount: ${document.getElementById('w-amount').value}`;
            window.location.href = `mailto:${email}?subject=${t}_Request&body=${body}`;
        };

        window.copyData = () => {
            navigator.clipboard.writeText(`ID: ${finalId} | Name: ${finalName}`);
            showToast("Copied!");
        };

        onValue(userRef, (s) => {
            if(!s.exists()) update(userRef, {exm: 500});
            const d = s.val() || {exm: 500};
            document.getElementById('e-val').innerText = d.exm;
            document.getElementById('u-val').innerText = (d.exm * 0.0005).toFixed(4);
        });
    </script>
</body>
</html>
